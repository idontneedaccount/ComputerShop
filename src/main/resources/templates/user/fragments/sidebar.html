<div class="col-lg-3" th:fragment="sidebar">
<div class="axil-shop-sidebar">
    <div class="d-lg-none">
        <button class="sidebar-close filter-close-btn"><i class="fas fa-times"></i></button>
    </div>
    
    <!-- Search Form -->
    <form id="product-filter-form" method="get" action="/user/shopping-page">
        
        <!-- Categories Section -->
        <div class="toggle-list product-categories active">
            <h6 class="title">Nhu C·∫ßu</h6>
            <div class="shop-submenu">
                <ul>
                    <li>
                        <div class="checkbox-container">
                            <input type="checkbox" 
                                   id="category-all"
                                   name="category" 
                                   value="" 
                                   class="sidebar-checkbox"
                                   th:checked="${#strings.isEmpty(selectedCategory)}" 
                                   onchange="handleAllCheckbox(this, 'category')">
                            <label for="category-all" class="sidebar-label">T·∫•t C·∫£</label>
                        </div>
                    </li>
                    <li th:each="category, iterStat : ${categories}">
                        <div class="checkbox-container">
                            <input type="checkbox" 
                                   th:id="|category-${iterStat.index}|"
                                   name="category" 
                                   th:value="${category.name}"
                                   class="sidebar-checkbox"
                                   th:checked="${selectedCategory != null && selectedCategory.contains(category.name)}"
                                   onchange="handleCategoryCheckbox(this)">
                            <label th:for="|category-${iterStat.index}|" 
                                   class="sidebar-label" 
                                   th:text="${category.name}"></label>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
        
        <!-- Brands Section -->
        <div class="toggle-list product-categories active">
            <h6 class="title">Th∆∞∆°ng Hi·ªáu</h6>
            <div class="shop-submenu">
                <ul>
                    <li>
                        <div class="checkbox-container">
                            <input type="checkbox" 
                                   id="brand-all"
                                   name="brand" 
                                   value="" 
                                   class="sidebar-checkbox"
                                   th:checked="${#strings.isEmpty(selectedBrand)}" 
                                   onchange="handleAllCheckbox(this, 'brand')">
                            <label for="brand-all" class="sidebar-label">T·∫•t C·∫£</label>
                        </div>
                    </li>
                    <li th:each="brand, iterStat : ${brands}">
                        <div class="checkbox-container">
                            <input type="checkbox" 
                                   th:id="|brand-${iterStat.index}|"
                                   name="brand" 
                                   th:value="${brand}"
                                   class="sidebar-checkbox"
                                   th:checked="${selectedBrand != null && selectedBrand.contains(brand)}"
                                   onchange="handleCategoryCheckbox(this)">
                            <label th:for="|brand-${iterStat.index}|" 
                                   class="sidebar-label" 
                                   th:text="${brand}"></label>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
        
        <!-- Search Button -->
        <button type="submit" class="axil-btn btn-bg-primary">T√¨m Ki·∫øm</button>
    </form>
</div>

<script>
console.log('üîß Sidebar Enhanced Script Loaded');

function handleAllCheckbox(allCheckbox, groupName) {
    console.log('üîÑ handleAllCheckbox called for group:', groupName);
    const checkboxes = document.querySelectorAll(`input.sidebar-checkbox[name="${groupName}"]`);
    console.log('Found checkboxes in group:', checkboxes.length);
    checkboxes.forEach(checkbox => {
        if (checkbox !== allCheckbox) {
            checkbox.checked = false;
        }
    });
}

function handleCategoryCheckbox(checkbox) {
    console.log('‚úÖ handleCategoryCheckbox called:', checkbox.name, '=', checkbox.value);
    if (checkbox.checked) {
        const allCheckbox = document.querySelector(`input.sidebar-checkbox[name="${checkbox.name}"][value=""]`);
        if (allCheckbox) {
            allCheckbox.checked = false;
            console.log('Unchecked "T·∫•t C·∫£" for group:', checkbox.name);
        }
    }
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Sidebar DOM loaded');
    
    const form = document.getElementById('product-filter-form');
    if (form) {
        console.log('üìù Form found:', form);
        
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            console.log('üõë Form submit prevented');
            
            const formData = new FormData(form);
            const params = new URLSearchParams();
            
            const groups = {};
            for (const [key, value] of formData.entries()) {
                console.log('üìä Form data:', key, '=', value);
                if (value && value.trim() !== '') {
                    if (!groups[key]) {
                        groups[key] = [];
                    }
                    groups[key].push(value);
                }
            }
            
            for (const [key, values] of Object.entries(groups)) {
                if (values.length > 0) {
                    params.append(key, values.join(','));
                }
            }
            
            const searchUrl = '/user/shopping-page' + (params.toString() ? '?' + params.toString() : '');
            console.log('üîó Redirecting to:', searchUrl);
            window.location.href = searchUrl;
        });
    } else {
        console.error('‚ùå Form not found!');
    }
});
</script>
</div>