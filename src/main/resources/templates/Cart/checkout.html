<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>eTrade || Thanh to√°n</title>
    <meta name="robots" content="noindex, follow" />
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Favicon -->
    <link rel="shortcut icon" th:href="@{/assets/images/favicon.png}" type="image/x-icon">
    <!-- CSS -->
    <link rel="stylesheet" th:href="@{/assets/css/vendor/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/assets/css/vendor/font-awesome.css}">
    <link rel="stylesheet" th:href="@{/assets/css/vendor/flaticon/flaticon.css}">
    <link rel="stylesheet" th:href="@{/assets/css/vendor/slick.css}">
    <link rel="stylesheet" th:href="@{/assets/css/vendor/slick-theme.css}">
    <link rel="stylesheet" th:href="@{/assets/css/vendor/jquery-ui.min.css}">
    <link rel="stylesheet" th:href="@{/assets/css/vendor/sal.css}">
    <link rel="stylesheet" th:href="@{/assets/css/vendor/magnific-popup.css}">
    <link rel="stylesheet" th:href="@{/assets/css/vendor/base.css}">
    <link rel="stylesheet" th:href="@{/assets/css/style.min.css}">
    <!-- Checkout Page Custom CSS -->
    <link rel="stylesheet" th:href="@{/assets/css/checkout-custom.css}">
    <link rel="stylesheet" th:href="@{/assets/css/shipping-calculator.css}">
</head>
<body class="sticky-header">
<!-- Back to top anchor -->
<div id="top"></div>

<!-- Back to top start -->
<a href="#top" class="back-to-top" id="backto-top"><i class="fal fa-arrow-up"></i></a>
<!-- Back to top end -->

<!-- Header -->
<header class="header axil-header header-style-5">
    <div th:replace="~{user/fragments/header2 :: header}"></div>
</header>

<main class="main-wrapper">
    <!-- Start Checkout Area  -->
    <div class="axil-checkout-area axil-section-gap">
        <div class="container">
            <!-- If cart is empty -->
            <div th:if="${cartItems == null || cartItems.isEmpty()}" class="row">
                <div class="col-12">
                    <div class="empty-cart-message text-center">
                        <h4>Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng</h4>
                        <p>B·∫°n c·∫ßn th√™m m·ªôt s·ªë s·∫£n ph·∫©m v√†o gi·ªè h√†ng tr∆∞·ªõc khi thanh to√°n.</p>
                        <a th:href="@{/cart/view}" class="axil-btn btn-bg-primary">ƒêi t·ªõi gi·ªè h√†ng</a>
                    </div>
                </div>
            </div>

            <!-- If cart has items -->
            <div th:if="${cartItems != null && !cartItems.isEmpty()}">

                <!-- Info Messages -->
                <div th:if="${param.info}" class="row mb-4">
                    <div class="col-12">
                        <div th:if="${param.info[0] == 'please_use_checkout_form'}" class="alert alert-info alert-dismissible fade show" role="alert">
                            <i class="fas fa-info-circle"></i>
                            <strong>Th√¥ng b√°o:</strong> Vui l√≤ng s·ª≠ d·ª•ng form checkout b√™n d∆∞·ªõi ƒë·ªÉ ƒë·∫∑t h√†ng.
                            H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông x·ª≠ l√Ω thanh to√°n VNPay sau khi b·∫°n ƒëi·ªÅn th√¥ng tin v√† nh·∫•n "Thanh to√°n".
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="ƒê√≥ng"></button>
                        </div>
                    </div>
                </div>

                <!-- Error Messages -->
                <div th:if="${param.error}" class="row mb-4">
                    <div class="col-12">
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>L·ªói:</strong>
                            <span th:if="${param.error[0] == 'order_not_found'}">Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng. Vui l√≤ng th·ª≠ l·∫°i.</span>
                            <span th:if="${param.error[0] == 'payment_creation_failed'}">Kh√¥ng th·ªÉ t·∫°o thanh to√°n. Vui l√≤ng th·ª≠ l·∫°i.</span>
                            <span th:if="${param.error[0] == 'vnpay_error'}">L·ªói VNPay. Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n kh√°c.</span>
                            <span th:if="${param.error[0] == 'missing_data'}">Thi·∫øu th√¥ng tin c·∫ßn thi·∫øt. Vui l√≤ng th·ª≠ l·∫°i.</span>
                            <span th:if="${param.error[0] == 'invalid_order_status'}">ƒê∆°n h√†ng kh√¥ng ·ªü tr·∫°ng th√°i h·ª£p l·ªá ƒë·ªÉ thanh to√°n. Vui l√≤ng t·∫°o ƒë∆°n h√†ng m·ªõi.</span>
                            <span th:if="${param.error[0] == 'amount_invalid'}">
                                    <span th:text="${param.message != null ? param.message[0] : 'S·ªë ti·ªÅn kh√¥ng h·ª£p l·ªá cho VNPay. Vui l√≤ng ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n kh√°c.'}"></span>
                                </span>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="ƒê√≥ng"></button>
                        </div>
                    </div>
                </div>

                <!-- Customer Info Section -->
                <div class="checkout-customer-section">
                    <div class="checkout-method-wrap">
                        <div class="single-method">
                            <i class="fal fa-user"></i>
                            Kh√°ch h√†ng quay l·∫°i? <a href="#" class="checkout-method-switcher">Nh·∫•n v√†o ƒë√¢y ƒë·ªÉ ƒëƒÉng nh·∫≠p</a>
                        </div>
                        <div class="single-method">
                            <i class="fal fa-tag"></i>
                            C√≥ voucher? <a href="#" class="checkout-method-switcher">Nh·∫•n v√†o ƒë√¢y ƒë·ªÉ nh·∫≠p m√£</a>
                        </div>
                    </div>
                </div>

                <form th:action="@{/cart/checkout}" method="post">
                    <div class="row">
                        <!-- Billing Details -->
                        <div class="col-lg-6">
                            <div class="axil-checkout-billing">
                                <h4 class="title mb--40">Th√¥ng tin thanh to√°n</h4>

                                <!-- Full Name -->
                                <div class="form-group">
                                    <label for="fullName">H·ªç v√† t√™n <span>*</span></label>
                                    <input type="text" id="fullName" name="fullName" placeholder="Nguy·ªÖn VƒÉn A" required>
                                </div>

                                <!-- Province/City -->
                                <div class="form-group">
                                    <label for="province">T·ªânh/Th√†nh ph·ªë <span>*</span></label>
                                    <select name="region" id="province" required>
                                        <option value="">Ch·ªçn t·ªânh/th√†nh ph·ªë</option>
                                        <option value="H√† N·ªôi">H√† N·ªôi</option>
                                        <option value="H·ªì Ch√≠ Minh">Th√†nh ph·ªë H·ªì Ch√≠ Minh</option>
                                        <option value="ƒê√† N·∫µng">ƒê√† N·∫µng</option>
                                        <option value="H·∫£i Ph√≤ng">H·∫£i Ph√≤ng</option>
                                        <option value="C·∫ßn Th∆°">C·∫ßn Th∆°</option>
                                        <option value="An Giang">An Giang</option>
                                        <option value="B√† R·ªãa - V≈©ng T√†u">B√† R·ªãa - V≈©ng T√†u</option>
                                        <option value="B·∫Øc Giang">B·∫Øc Giang</option>
                                        <option value="B·∫Øc K·∫°n">B·∫Øc K·∫°n</option>
                                        <option value="B·∫°c Li√™u">B·∫°c Li√™u</option>
                                        <option value="B·∫Øc Ninh">B·∫Øc Ninh</option>
                                        <option value="B·∫øn Tre">B·∫øn Tre</option>
                                        <option value="B√¨nh ƒê·ªãnh">B√¨nh ƒê·ªãnh</option>
                                        <option value="B√¨nh D∆∞∆°ng">B√¨nh D∆∞∆°ng</option>
                                        <option value="B√¨nh Ph∆∞·ªõc">B√¨nh Ph∆∞·ªõc</option>
                                        <option value="B√¨nh Thu·∫≠n">B√¨nh Thu·∫≠n</option>
                                        <option value="C√† Mau">C√† Mau</option>
                                        <option value="Cao B·∫±ng">Cao B·∫±ng</option>
                                        <option value="ƒê·∫Øk L·∫Øk">ƒê·∫Øk L·∫Øk</option>
                                        <option value="ƒê·∫Øk N√¥ng">ƒê·∫Øk N√¥ng</option>
                                        <option value="ƒêi·ªán Bi√™n">ƒêi·ªán Bi√™n</option>
                                        <option value="ƒê·ªìng Nai">ƒê·ªìng Nai</option>
                                        <option value="ƒê·ªìng Th√°p">ƒê·ªìng Th√°p</option>
                                        <option value="Gia Lai">Gia Lai</option>
                                        <option value="H√† Giang">H√† Giang</option>
                                        <option value="H√† Nam">H√† Nam</option>
                                        <option value="H√† Tƒ©nh">H√† Tƒ©nh</option>
                                        <option value="H·∫£i D∆∞∆°ng">H·∫£i D∆∞∆°ng</option>
                                        <option value="H·∫≠u Giang">H·∫≠u Giang</option>
                                        <option value="H√≤a B√¨nh">H√≤a B√¨nh</option>
                                        <option value="H∆∞ng Y√™n">H∆∞ng Y√™n</option>
                                        <option value="Kh√°nh H√≤a">Kh√°nh H√≤a</option>
                                        <option value="Ki√™n Giang">Ki√™n Giang</option>
                                        <option value="Kon Tum">Kon Tum</option>
                                        <option value="Lai Ch√¢u">Lai Ch√¢u</option>
                                        <option value="L√¢m ƒê·ªìng">L√¢m ƒê·ªìng</option>
                                        <option value="L·∫°ng S∆°n">L·∫°ng S∆°n</option>
                                        <option value="L√†o Cai">L√†o Cai</option>
                                        <option value="Long An">Long An</option>
                                        <option value="Nam ƒê·ªãnh">Nam ƒê·ªãnh</option>
                                        <option value="Ngh·ªá An">Ngh·ªá An</option>
                                        <option value="Ninh B√¨nh">Ninh B√¨nh</option>
                                        <option value="Ninh Thu·∫≠n">Ninh Thu·∫≠n</option>
                                        <option value="Ph√∫ Th·ªç">Ph√∫ Th·ªç</option>
                                        <option value="Ph√∫ Y√™n">Ph√∫ Y√™n</option>
                                        <option value="Qu·∫£ng B√¨nh">Qu·∫£ng B√¨nh</option>
                                        <option value="Qu·∫£ng Nam">Qu·∫£ng Nam</option>
                                        <option value="Qu·∫£ng Ng√£i">Qu·∫£ng Ng√£i</option>
                                        <option value="Qu·∫£ng Ninh">Qu·∫£ng Ninh</option>
                                        <option value="Qu·∫£ng Tr·ªã">Qu·∫£ng Tr·ªã</option>
                                        <option value="S√≥c TrƒÉng">S√≥c TrƒÉng</option>
                                        <option value="S∆°n La">S∆°n La</option>
                                        <option value="T√¢y Ninh">T√¢y Ninh</option>
                                        <option value="Th√°i B√¨nh">Th√°i B√¨nh</option>
                                        <option value="Th√°i Nguy√™n">Th√°i Nguy√™n</option>
                                        <option value="Thanh H√≥a">Thanh H√≥a</option>
                                        <option value="Th·ª´a Thi√™n Hu·∫ø">Th·ª´a Thi√™n Hu·∫ø</option>
                                        <option value="Ti·ªÅn Giang">Ti·ªÅn Giang</option>
                                        <option value="Tr√† Vinh">Tr√† Vinh</option>
                                        <option value="Tuy√™n Quang">Tuy√™n Quang</option>
                                        <option value="Vƒ©nh Long">Vƒ©nh Long</option>
                                        <option value="Vƒ©nh Ph√∫c">Vƒ©nh Ph√∫c</option>
                                        <option value="Y√™n B√°i">Y√™n B√°i</option>
                                    </select>
                                </div>

                                <!-- District -->
                                <div class="form-group">
                                    <label for="district">Qu·∫≠n/Huy·ªán <span>*</span></label>
                                    <input type="text" name="district" id="district" placeholder="Qu·∫≠n/Huy·ªán" required>
                                </div>

                                <!-- Ward -->
                                <div class="form-group">
                                    <label for="ward">Ph∆∞·ªùng/X√£</label>
                                    <input type="text" name="ward" id="ward" placeholder="Ph∆∞·ªùng/X√£">
                                </div>

                                <!-- Street Address -->
                                <div class="form-group">
                                    <label for="address">S·ªë nh√†, t√™n ƒë∆∞·ªùng <span>*</span></label>
                                    <input type="text" name="address" id="address" placeholder="S·ªë nh√†, t√™n ƒë∆∞·ªùng" required>
                                </div>

                                <input type="hidden" name="city" id="city">

                                <!-- Distance and Shipping Info -->
                                <div class="form-group" id="shipping-info" style="display: none;">
                                    <div class="alert alert-info">
                                        <h6><i class="fas fa-route"></i> Th√¥ng tin giao h√†ng</h6>
                                        <p><strong>Kho·∫£ng c√°ch:</strong> <span id="distance-display">-</span> km</p>
                                        <p><strong>Th·ªùi gian giao h√†ng d·ª± ki·∫øn:</strong> <span id="delivery-time">-</span></p>
                                    </div>
                                </div>

                                <!-- Hidden fields for shipping calculation -->
                                <input type="hidden" name="distance" id="distance-value">
                                <input type="hidden" name="shippingFee" id="shipping-fee-value">

                                <!-- Phone -->
                                <div class="form-group">
                                    <label for="phone">S·ªë ƒëi·ªán tho·∫°i <span>*</span></label>
                                    <input type="tel" id="phone" name="phone" placeholder="+84 123 456 789" required>
                                </div>

                                <!-- Email Address -->
                                <div class="form-group">
                                    <label for="email">ƒê·ªãa ch·ªâ Email <span>*</span></label>
                                    <input type="email" id="email" name="email" placeholder="example@domain.com" required>
                                </div>

                                <!-- Create Account Checkbox -->
                                <div class="form-group">
                                    <div class="checkout-box">
                                        <input type="checkbox" class="checkbox-primary" id="create-account">
                                        <label for="create-account">T·∫°o t√†i kho·∫£n?</label>
                                    </div>
                                </div>

                                <!-- Ship to Different Address -->
                                <div class="different-address">
                                    <div class="checkout-box">
                                        <input type="checkbox" class="checkbox-primary" id="different-address">
                                        <label for="different-address">Giao h√†ng ƒë·∫øn ƒë·ªãa ch·ªâ kh√°c?</label>
                                    </div>
                                </div>

                                <!-- Order Notes -->
                                <div class="form-group">
                                    <label for="order-notes">Ghi ch√∫ ƒë∆°n h√†ng (t√πy ch·ªçn)</label>
                                    <textarea id="order-notes" name="note" rows="3" placeholder="Ghi ch√∫ v·ªÅ ƒë∆°n h√†ng c·ªßa b·∫°n, v√≠ d·ª•: ghi ch√∫ ƒë·∫∑c bi·ªát cho vi·ªác giao h√†ng."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Order Summary -->
                        <div class="col-lg-6">
                            <div class="axil-order-summery order-checkout-summery">
                                <h5 class="title mb--20">ƒê∆°n h√†ng c·ªßa b·∫°n</h5>

                                <!-- Voucher Section -->
                                <div class="voucher-section mb-3">
                                    <div th:if="${hasVoucher}" class="applied-voucher">
                                        <div class="alert alert-success">
                                            <strong>‚úì ƒê√£ √°p d·ª•ng Voucher: </strong>
                                            <span th:text="${voucherCode}">VOUCHER20</span>
                                            <span class="text-success ms-2">(-<span th:text="${#numbers.formatDecimal(totalDiscount, 0, 'COMMA', 0, 'POINT')}">0</span> VND)</span>
                                            <a th:href="@{/cart/remove-voucher(redirect='checkout')}" class="btn btn-sm btn-outline-danger ms-2">X√≥a</a>
                                        </div>
                                    </div>

                                    <div class="voucher-form">
                                        <form th:action="@{/cart/apply-voucher}" method="post">
                                            <div class="input-group mb-2">
                                                <label for="voucher-code" class="sr-only">M√£ Voucher</label>
                                                <input type="text" id="voucher-code" name="voucherCode" th:value="${voucherCode}" placeholder="Nh·∫≠p m√£ voucher" class="form-control">
                                                <input type="hidden" name="redirect" value="checkout">
                                                <div class="input-group-append" style=" position: absolute; margin-top: 15px; margin-left: 500px;">
                                                    <button type="submit" class="btn btn-outline-primary btn-sm px-3">√Åp d·ª•ng</button>
                                                </div>
                                            </div>
                                        </form>
                                    </div>

                                    <!-- Voucher Messages -->
                                    <div th:if="${voucherError}" class="alert alert-danger alert-sm">
                                        <span th:text="${voucherError}">Error message</span>
                                    </div>
                                    <div th:if="${voucherSuccess}" class="alert alert-success alert-sm">
                                        <span th:text="${voucherSuccess}">Success message</span>
                                    </div>
                                </div>

                                <div class="summery-table-wrap">
                                    <table class="table summery-table mb--30">
                                        <thead>
                                        <tr>
                                            <th>S·∫£n ph·∫©m</th>
                                            <th>T·∫°m t√≠nh</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <!-- Product Items -->
                                        <tr th:each="item : ${cartItems}">
                                            <td>
                                                <span th:text="${item.product.name}">Product Name</span>
                                                <i class="fas fa-times"></i>
                                                <span th:text="${item.quantity}">1</span>
                                            </td>
                                            <td>
                                                <span th:text="${#numbers.formatDecimal(item.product.price * item.quantity, 0, 'COMMA', 0, 'POINT')}">0</span> ‚Ç´
                                            </td>
                                        </tr>

                                        <!-- Subtotal -->
                                        <tr class="order-subtotal">
                                            <td>T·∫°m t√≠nh</td>
                                            <td><span th:text="${#numbers.formatDecimal(originalTotal, 0, 'COMMA', 0, 'POINT')}">0</span> ‚Ç´</td>
                                        </tr>

                                        <!-- Voucher Discount Row -->
                                        <tr th:if="${hasVoucher and totalDiscount > 0}" class="order-discount">
                                            <td>
                                                <span>Gi·∫£m gi√°</span>
                                                <small th:if="${voucherCode}" class="text-muted">(<span th:text="${voucherCode}"></span>)</small>
                                            </td>
                                            <td class="text-success">-<span th:text="${#numbers.formatDecimal(totalDiscount, 0, 'COMMA', 0, 'POINT')}">0</span> ‚Ç´</td>
                                        </tr>

                                        <!-- Shipping method -->
                                        <tr class="order-shipping">
                                            <td>Ph∆∞∆°ng th·ª©c giao h√†ng</td>
                                            <td>
                                                <strong>Giao h√†ng ti√™u chu·∫©n (2-8 ng√†y)</strong>
                                                <br><small class="text-muted" id="standard-fee-main">- T√≠nh ph√≠ khi c√≥ ƒë·ªãa ch·ªâ</small>
                                                <input type="hidden" name="shippingMethod" value="standard">
                                            </td>
                                        </tr>

                                        <!-- Shipping Fee Row -->
                                        <tr class="order-shipping-fee" id="shipping-fee-row-main" style="display: none;">
                                            <td>Ph√≠ giao h√†ng</td>
                                            <td><span id="current-shipping-fee-main">0</span> ‚Ç´</td>
                                        </tr>

                                        <!-- Total -->
                                        <tr class="order-total">
                                            <td><strong>T·ªïng c·ªông</strong></td>
                                            <td class="order-total-amount">
                                                <strong><span th:text="${#numbers.formatDecimal(finalTotal, 0, 'COMMA', 0, 'POINT')}">0</span> ‚Ç´</strong>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Payment Methods -->
                                <div class="order-payment-method" style="border: 3px solid #ff6b35; padding: 25px; margin: 25px 0; background: #fff8f5; border-radius: 10px;">
                                    <h4 style="margin-bottom: 25px; color: #ff6b35; text-align: center; font-size: 20px;">CH·ªåN PH∆Ø∆†NG TH·ª®C THANH TO√ÅN</h4>

                                    <!-- Cash on Delivery -->
                                    <div class="single-payment cod-payment" style="margin-bottom: 20px; padding: 20px; border: 2px solid #28a745; background: #f8fff8; border-radius: 8px; cursor: pointer; transition: all 0.3s;">
                                        <div class="input-group" style="display: flex; align-items: center;">
                                            <input type="radio" id="radio-cod" name="paymentMethod" value="COD" required checked style="margin-right: 15px; transform: scale(1.5);">
                                            <label for="radio-cod" style="margin: 0; font-weight: 700; font-size: 16px; color: #28a745; cursor: pointer;">THANH TO√ÅN KHI NH·∫¨N H√ÄNG (COD)</label>
                                        </div>
                                        <p style="margin: 15px 0 0 40px; color: #666; font-size: 14px;">Thanh to√°n b·∫±ng ti·ªÅn m·∫∑t khi nh·∫≠n h√†ng t·∫°i nh√†.</p>
                                    </div>

                                    <!-- VNPay Payment - Made VERY PROMINENT -->
                                    <div class="single-payment vnpay-payment" style="margin-bottom: 20px; padding: 20px; border: 3px solid #007bff; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-radius: 8px; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 8px rgba(0,123,255,0.2);">
                                        <div class="input-group" style="display: flex; align-items: center;">
                                            <input type="radio" id="radio-vnpay" name="paymentMethod" value="VNPAY" required style="margin-right: 15px; transform: scale(1.5);">
                                            <label for="radio-vnpay" style="margin: 0; font-weight: 700; font-size: 18px; color: #007bff; cursor: pointer;">THANH TO√ÅN QUA VNPAY (ATM/BANKING/QR)</label>
                                        </div>
                                        <div style="margin: 15px 0 0 40px;">
                                            <p style="color: #333; font-size: 15px; margin: 5px 0; font-weight: 600;">THANH TO√ÅN NHANH - AN TO√ÄN - TI·ªÜN L·ª¢I:</p>
                                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                                                <span style="color: #007bff; font-weight: 500;">Qu√©t m√£ QR</span>
                                                <span style="color: #007bff; font-weight: 500;">Internet Banking</span>
                                                <span style="color: #007bff; font-weight: 500;">Th·∫ª ATM n·ªôi ƒë·ªãa</span>
                                                <span style="color: #007bff; font-weight: 500;">V√≠ ƒëi·ªán t·ª≠</span>
                                            </div>
                                        </div>
                                    </div>

                                </div>

                                <!-- Place Order Button -->
                                <button type="submit" class="axil-btn btn-bg-primary checkout-btn w-100">Thanh to√°n</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- End Checkout Area  -->
</main>

<!-- Footer -->
<div th:replace="~{user/fragments/footer :: footer}"></div>

<!-- Additional fragments -->
<div th:replace="~{user/fragments/cartreview :: cartreview}"></div>

<!-- Shipping Calculator JavaScript -->
<script th:src="@{/assets/js/shipping-calculator.js}"></script>

<!-- Payment Method JavaScript -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ Page loaded - Initializing payment script...');

        const checkoutForm = document.querySelector('form[action*="/cart/checkout"]');
        const checkoutBtn = document.querySelector('.checkout-btn');
        const paymentMethods = document.querySelectorAll('input[name="paymentMethod"]');
        const regionSelect = document.getElementById('province');
        const cityField = document.getElementById('city');

        console.log('üîç Elements found:');
        console.log('- Form:', checkoutForm);
        console.log('- Button:', checkoutBtn);
        console.log('- Payment methods:', paymentMethods.length);

        // Set city value from region selection
        if (regionSelect && cityField) {
            regionSelect.addEventListener('change', function() {
                cityField.value = this.value;
                console.log('üèôÔ∏è City set to:', this.value);
            });
            // Set initial value
            if (regionSelect.value) {
                cityField.value = regionSelect.value;
                console.log('üèôÔ∏è Initial city set to:', regionSelect.value);
            }
        }

        if (checkoutForm && checkoutBtn) {
            console.log('‚úÖ Adding form submit event listener...');

            checkoutForm.addEventListener('submit', function(e) {
                console.log('üìù Form submitted!');

                // Check if submit button is disabled (shipping not calculated)
                if (checkoutBtn.disabled) {
                    console.log('‚ùå Submit blocked - shipping not calculated');
                    e.preventDefault();
                    e.stopPropagation();
                    alert('Vui l√≤ng ch·ªù h·ªá th·ªëng t√≠nh ph√≠ giao h√†ng tr∆∞·ªõc khi thanh to√°n!');
                    return;
                }

                const selectedPaymentMethod = document.querySelector('input[name="paymentMethod"]:checked');
                console.log('üí≥ Selected payment method:', selectedPaymentMethod ? selectedPaymentMethod.value : 'NONE');

                if (!selectedPaymentMethod) {
                    console.log('‚ùå No payment method selected');
                    e.preventDefault();
                    alert('Vui l√≤ng ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n!');
                    return;
                }

                // Validate required fields
                const fullName = checkoutForm.querySelector('[name="fullName"]').value;
                const phone = checkoutForm.querySelector('[name="phone"]').value;
                const address = checkoutForm.querySelector('[name="address"]').value;
                const region = checkoutForm.querySelector('[name="region"]').value;

                if (!fullName || !phone || !address || !region) {
                    console.log('‚ùå Validation failed!');
                    e.preventDefault();
                    alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc!');
                    return;
                }

                // Set city if empty
                const cityField = checkoutForm.querySelector('[name="city"]');
                if (!cityField.value) {
                    cityField.value = region;
                    console.log('üèôÔ∏è City was empty, set to region:', region);
                }

                // Update button based on payment method and disable to prevent double submit
                checkoutBtn.disabled = true;
                if (selectedPaymentMethod.value === 'VNPAY') {
                    console.log('üîµ VNPay selected - Backend will handle redirect');
                    checkoutBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω VNPay...';
                } else if (selectedPaymentMethod.value === 'COD') {
                    console.log('üü¢ COD selected - Processing order');
                    checkoutBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω ƒë∆°n h√†ng...';
                }

                // Allow form to submit normally - backend will handle the rest
            });

            // Add click handlers for payment method selection
            paymentMethods.forEach((method, index) => {
                console.log(`‚ûï Adding change listener for payment method ${index + 1}:`, method.value);

                method.addEventListener('change', function() {
                    console.log('üîÑ Payment method changed to:', this.value);

                    // Update button text based on selection
                    if (this.value === 'VNPAY') {
                        checkoutBtn.innerHTML = 'Thanh to√°n VNPay';
                        checkoutBtn.style.background = '#007bff';
                        console.log('üîµ Button updated for VNPay');
                    } else if (this.value === 'COD') {
                        checkoutBtn.innerHTML = 'ƒê·∫∑t h√†ng COD';
                        checkoutBtn.style.background = '#28a745';
                        console.log('üü¢ Button updated for COD');
                    }

                    // Visual feedback
                    paymentMethods.forEach(m => {
                        const parent = m.closest('.single-payment');
                        if (parent) {
                            if (m.checked) {
                                parent.style.background = '#e7f3ff';
                                parent.style.borderColor = '#007bff';
                            } else {
                                parent.style.background = 'white';
                                parent.style.borderColor = '#ccc';
                            }
                        }
                    });
                });
            });

            // Initial setup
            const initialSelected = document.querySelector('input[name="paymentMethod"]:checked');
            if (initialSelected) {
                console.log('üéØ Initial payment method:', initialSelected.value);
                initialSelected.dispatchEvent(new Event('change'));
            } else {
                console.log('‚ö†Ô∏è No payment method initially selected');
            }

            console.log('‚úÖ Payment script initialization complete!');
        } else {
            console.log('‚ùå Form or button not found!');
            console.log('- Form:', checkoutForm);
            console.log('- Button:', checkoutBtn);
        }
    });
</script>

</body>
</html> 