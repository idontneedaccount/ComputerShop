<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
    <head th:replace="~{admin/fragments/header :: header}">
        <title>Quản lý Thông báo</title>
    </head>
<body id="page-top">

    <nav th:replace="~{admin/fragments/nav-bar :: nav-bar}"></nav>

    <div id="wrapper">
        <!-- Sidebar -->
        <ul th:replace="~{admin/fragments/sidebar :: sidebar}"></ul>

        <div id="content-wrapper">
                <div class="container-fluid">
                    <!-- Page Heading -->
                    <div class="d-sm-flex align-items-center justify-content-between mb-4">
                        <h1 class="h3 mb-0 text-gray-800">
                            <i class="fas fa-bullhorn fa-fw me-2"></i>Gửi thông báo tổng
                        </h1>
                        <a href="/notifications/admin" class="btn btn-secondary btn-sm">
                            <i class="fas fa-arrow-left fa-sm me-1"></i>
                            Quay lại
                        </a>
                    </div>

                    <!-- Alert Messages -->
                    <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
                        <i class="fas fa-check-circle me-2"></i>
                        <span th:text="${success}"></span>
                        <button type="button" class="close" data-dismiss="alert">
                            <span>&times;</span>
                        </button>
                    </div>

                    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        <span th:text="${error}"></span>
                        <button type="button" class="close" data-dismiss="alert">
                            <span>&times;</span>
                        </button>
                    </div>

                    <div class="row">
                        <!-- Form Column -->
                        <div class="col-lg-8">
                            <div class="card shadow mb-4">
                                <div class="card-header py-3">
                                    <h6 class="m-0 font-weight-bold ">
                                        <i class="fas fa-edit me-2"></i>Soạn thông báo
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <form method="post" action="/notifications/admin/broadcast" id="broadcastForm">
                                        <div class="form-group">
                                            <label for="message" class="form-label">
                                                <i class="fas fa-comment me-1"></i>
                                                Nội dung thông báo <span class="text-danger">*</span>
                                            </label>
                                            <textarea class="form-control" 
                                                    id="message" 
                                                    name="message" 
                                                    rows="6" 
                                                    placeholder="Nhập nội dung thông báo bạn muốn gửi đến tất cả người dùng..."
                                                    maxlength="1000"
                                                    required></textarea>
                                            <div class="d-flex justify-content-between mt-2">
                                                <small class="text-muted">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    Thông báo sẽ được gửi đến tất cả người dùng đang hoạt động
                                                </small>
                                                <small class="character-count" id="charCount">0/1000</small>
                                            </div>
                                        </div>

                                        <div class="form-group mt-4">
                                            <div class="d-flex justify-content-between">
                                                <button type="button" class="btn btn-outline-secondary" onclick="clearForm()">
                                                    <i class="fas fa-eraser me-1"></i>
                                                    Xóa nội dung
                                                </button>
                                                <div>
                                                    <button type="button" class="btn btn-info me-2" id="previewBtn">
                                                        <i class="fas fa-eye me-1"></i>
                                                        Xem trước
                                                    </button>
                                                    <button type="submit" class="btn btn-primary" id="sendBtn">
                                                        <i class="fas fa-paper-plane me-1"></i>
                                                        Gửi thông báo
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Preview Column -->
                        <div class="col-lg-4">
                            <div class="card shadow preview-card">
                                <div class="card-header py-3">
                                    <h6 class="m-0 font-weight-bold ">
                                        <i class="fas fa-mobile-alt me-2"></i>Xem trước
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="notification-preview">
                                        <div class="d-flex align-items-start mb-3">
                                            <div class="notification-icon me-3" style="width: 40px; height: 40px; background-color: #e8f5e8; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                                <i class="fas fa-info-circle" style="color: #388e3c;"></i>
                                            </div>
                                            <div class="flex-grow-1">
                                                <div class="notification-content" id="previewContent">
                                                    <p class="text-muted mb-2">Nội dung thông báo sẽ hiển thị ở đây...</p>
                                                </div>
                                                <div class="notification-meta" style="font-size: 0.875rem; color: #6c757d;">
                                                    <i class="fas fa-clock me-1"></i>
                                                    <span id="previewTime">Vừa xong</span>
                                                    <span class="badge badge-success ms-2">Mới</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <hr>
                                    
                                    <div class="notification-info">
                                        <h6><i class="fas fa-users me-1"></i>Người nhận</h6>
                                        <p class="text-muted mb-2">
                                            <i class="fas fa-check-circle text-success me-1"></i>
                                            Tất cả người dùng đang hoạt động
                                        </p>
                                        <p class="text-muted mb-0">
                                            <i class="fas fa-exclamation-triangle text-warning me-1"></i>
                                            Thông báo không thể hoàn tác sau khi gửi
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- Tips Card -->
                            <div class="card shadow mt-4">
                                <div class="card-header py-3">
                                    <h6 class="m-0 font-weight-bold ">
                                        <i class="fas fa-lightbulb me-2"></i>Gợi ý
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <ul class="list-unstyled mb-0">
                                        <li class="mb-2">
                                            <i class="fas fa-check text-success me-2"></i>
                                            Sử dụng ngôn ngữ rõ ràng, dễ hiểu
                                        </li>
                                        <li class="mb-2">
                                            <i class="fas fa-check text-success me-2"></i>
                                            Đề cập thông tin quan trọng ở đầu
                                        </li>
                                        <li class="mb-2">
                                            <i class="fas fa-check text-success me-2"></i>
                                            Tránh sử dụng từ ngữ spam
                                        </li>
                                        <li class="mb-0">
                                            <i class="fas fa-check text-success me-2"></i>
                                            Kiểm tra chính tả trước khi gửi
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <footer th:replace="~{admin/fragments/footer :: footer}"></footer>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                        Xác nhận gửi thông báo
                    </h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Bạn có chắc chắn muốn gửi thông báo này đến <strong>tất cả người dùng</strong>?</p>
                    <div class="alert alert-warning">
                        <i class="fas fa-info-circle me-2"></i>
                        Thao tác này không thể hoàn tác!
                    </div>
                    <div class="notification-preview-modal">
                        <strong>Nội dung:</strong>
                        <div class="border p-3 mt-2 bg-light rounded" id="modalPreviewContent">
                            <!-- Content will be filled by JavaScript -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Hủy
                    </button>
                    <button type="button" class="btn btn-primary" id="confirmSendBtn">
                        <i class="fas fa-paper-plane me-1"></i>Xác nhận gửi
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Scripts -->
    <script src="/assets2/vendor/jquery/jquery.min.js" th:src="@{/assets2/vendor/jquery/jquery.min.js}"></script>
    <script src="/assets2/vendor/bootstrap/js/bootstrap.bundle.min.js" th:src="@{/assets2/vendor/bootstrap/js/bootstrap.bundle.min.js}"></script>
    <script src="/assets2/js/sb-admin.min.js" th:src="@{/assets2/js/sb-admin.min.js}"></script>

    <script>
        $(document).ready(function() {
            const messageTextarea = $('#message');
            const charCount = $('#charCount');
            const previewContent = $('#previewContent');
            const previewTime = $('#previewTime');
            const broadcastForm = $('#broadcastForm');

            // Character counter and live preview
            messageTextarea.on('input', function() {
                const currentLength = $(this).val().length;
                charCount.text(`${currentLength}/1000`);
                
                // Update character count styling
                charCount.removeClass('warning danger');
                if (currentLength > 800) {
                    charCount.addClass('warning');
                }
                if (currentLength > 950) {
                    charCount.addClass('danger');
                }

                // Update preview
                const content = $(this).val().trim();
                if (content) {
                    previewContent.html(`<p class="mb-0">${content}</p>`);
                } else {
                    previewContent.html('<p class="text-muted mb-2">Nội dung thông báo sẽ hiển thị ở đây...</p>');
                }

                // Update preview time
                const now = new Date();
                previewTime.text(now.toLocaleTimeString('vi-VN', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                }));
            });

            // Form submission with confirmation
            broadcastForm.on('submit', function(e) {
                e.preventDefault();
                
                const message = messageTextarea.val().trim();
                if (!message) {
                    alert('Vui lòng nhập nội dung thông báo');
                    return;
                }

                // Show preview in modal
                $('#modalPreviewContent').text(message);
                $('#confirmModal').modal('show');
            });

            // Confirm send
            $('#confirmSendBtn').click(function() {
                $('#confirmModal').modal('hide');
                $('#sendBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>Đang gửi...');
                broadcastForm.off('submit').submit();
            });

            // Preview button
            $('#previewBtn').click(function() {
                const message = messageTextarea.val().trim();
                if (!message) {
                    alert('Vui lòng nhập nội dung thông báo để xem trước');
                    return;
                }
                
                // Scroll to preview
                $('html, body').animate({
                    scrollTop: $('.preview-card').offset().top - 100
                }, 500);
            });

            // Auto-dismiss alerts
            setTimeout(function() {
                $('.alert').alert('close');
            }, 5000);
        });

        function clearForm() {
            if (confirm('Bạn có chắc chắn muốn xóa toàn bộ nội dung?')) {
                $('#message').val('');
                $('#charCount').text('0/1000').removeClass('warning danger');
                $('#previewContent').html('<p class="text-muted mb-2">Nội dung thông báo sẽ hiển thị ở đây...</p>');
            }
        }
    </script>
</html> 