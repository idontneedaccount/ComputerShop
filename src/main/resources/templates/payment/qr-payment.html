<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh to√°n VNPay - Computer Shop</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
</head>
<body class="bg-light">
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card shadow">
                <div class="card-header bg-primary text-white text-center">
                    <h4 class="mb-0"><i class="fab fa-vnpay"></i> Thanh to√°n VNPay</h4>
                </div>
                <div class="card-body p-4">
                    <!-- Payment Status -->
                    <div id="payment-status" class="text-center mb-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">ƒêang t·∫°o m√£ QR...</span>
                        </div>
                        <p class="mt-2">ƒêang kh·ªüi t·∫°o thanh to√°n...</p>
                    </div>

                    <div class="row">
                        <!-- QR Code Section -->
                        <div class="col-md-6">
                            <div class="qr-section text-center">
                                <h5 class="mb-3">
                                    <i class="fas fa-qrcode"></i> Qu√©t m√£ QR ƒë·ªÉ thanh to√°n
                                </h5>

                                <!-- QR Code will be generated here -->
                                <div id="qr-code-container" class="mb-3" style="display: none;">
                                    <canvas id="qr-canvas" class="border border-primary"></canvas>
                                </div>

                                <!-- Loading QR -->
                                <div id="qr-loading" class="mb-3">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">ƒêang t·∫°o m√£ QR...</span>
                                    </div>
                                    <p class="mt-2">ƒêang t·∫°o m√£ QR...</p>
                                    <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="refreshQRCode()">
                                        <i class="fas fa-refresh"></i> L√†m m·ªõi QR
                                    </button>
                                </div>

                                <!-- Instructions -->
                                <div id="payment-instructions" class="alert alert-info" style="display: none;">
                                    <h6><i class="fas fa-mobile-alt"></i> H∆∞·ªõng d·∫´n thanh to√°n:</h6>
                                    <ol class="text-start">
                                        <li>M·ªü ·ª©ng d·ª•ng ng√¢n h√†ng ho·∫∑c v√≠ ƒëi·ªán t·ª≠</li>
                                        <li>Ch·ªçn t√≠nh nƒÉng qu√©t m√£ QR</li>
                                        <li>Qu√©t m√£ QR tr√™n m√†n h√¨nh</li>
                                        <li>X√°c nh·∫≠n th√¥ng tin v√† thanh to√°n</li>
                                    </ol>
                                </div>

                                <!-- Manual Payment Button -->
                                <div id="manual-payment-section" style="display: none;">
                                    <a id="vnpay-manual-link" href="#" class="btn btn-primary btn-lg" target="_blank">
                                        <i class="fas fa-external-link-alt"></i> Thanh to√°n tr·ª±c ti·∫øp
                                    </a>
                                    <p class="text-muted mt-2 small">Nh·∫•n v√†o ƒë√¢y n·∫øu kh√¥ng th·ªÉ qu√©t QR</p>
                                </div>
                            </div>
                        </div>

                        <!-- Order Information -->
                        <div class="col-md-6">
                            <div class="order-info">
                                <h5 class="mb-3">
                                    <i class="fas fa-shopping-cart"></i> Th√¥ng tin ƒë∆°n h√†ng
                                </h5>

                                <div class="card bg-light">
                                    <div class="card-body">
                                        <div class="row mb-2">
                                            <div class="col-6"><strong>M√£ ƒë∆°n h√†ng:</strong></div>
                                            <div class="col-6 text-end">
                                                <span class="text-primary" th:text="${orderId}">#ORDER_ID</span>
                                            </div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-6"><strong>Ng∆∞·ªùi nh·∫≠n:</strong></div>
                                            <div class="col-6 text-end" th:text="${fullName}">T√™n ng∆∞·ªùi nh·∫≠n</div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-6"><strong>S·ªë ƒëi·ªán tho·∫°i:</strong></div>
                                            <div class="col-6 text-end" th:text="${phone}">S·ªë ƒëi·ªán tho·∫°i</div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-6"><strong>ƒê·ªãa ch·ªâ:</strong></div>
                                            <div class="col-6 text-end" th:text="${address}">ƒê·ªãa ch·ªâ</div>
                                        </div>
                                        <hr>
                                        <div class="row">
                                            <div class="col-6"><strong>T·ªïng ti·ªÅn:</strong></div>
                                            <div class="col-6 text-end">
                                                <strong class="text-success" th:text="${#numbers.formatDecimal(totalAmount, 0, 'COMMA', 0, 'POINT')} + ' VND'">0 VND</strong>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Payment Timer -->
                                <div class="payment-timer mt-3 text-center">
                                    <div class="alert alert-warning">
                                        <i class="fas fa-clock"></i>
                                        <strong>Th·ªùi gian c√≤n l·∫°i:</strong>
                                        <span id="countdown-timer" class="fw-bold">15:00</span>
                                    </div>
                                </div>

                                <!-- Payment Status Updates -->
                                <div id="status-updates" class="mt-3">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle"></i>
                                        <span id="status-message">ƒêang ch·ªù thanh to√°n...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="row mt-4">
                        <div class="col-12 text-center">
                            <button id="refresh-qr" class="btn btn-outline-primary me-2" onclick="refreshQRCode()">
                                <i class="fas fa-sync-alt"></i> L√†m m·ªõi QR
                            </button>
                            <a href="/cart/checkout" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left"></i> Quay l·∫°i checkout
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    // Variables from Thymeleaf
    const vnpayUrl = /*[[${vnpayUrl}]]*/ '';
    const orderId = /*[[${orderId}]]*/ '';

    let paymentCheckInterval;
    let countdownInterval;
    let timeLeft = 15 * 60; // 15 minutes in seconds

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        generateQRCode();
        startPaymentPolling();
        startCountdown();
    });

    // Generate QR Code with timeout
    function generateQRCode() {
        console.log('üöÄ Starting QR generation...');
        console.log('VNPay URL:', vnpayUrl);
        
        if (!vnpayUrl || vnpayUrl === '') {
            showError('URL thanh to√°n kh√¥ng h·ª£p l·ªá. Vui l√≤ng th·ª≠ l·∫°i.');
            return;
        }

        // Set timeout for QR generation
        const qrTimeout = setTimeout(() => {
            showError('T·∫°o m√£ QR qu√° l√¢u. Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c thanh to√°n tr·ª±c ti·∫øp.');
            // Show manual payment as fallback
            document.getElementById('manual-payment-section').style.display = 'block';
            document.getElementById('vnpay-manual-link').href = vnpayUrl;
        }, 10000); // 10 second timeout

        const canvas = document.getElementById('qr-canvas');
        QRCode.toCanvas(canvas, vnpayUrl, {
            width: 250,
            height: 250,
            margin: 2,
            color: {
                dark: '#000000',
                light: '#FFFFFF'
            }
        }, function (error) {
            clearTimeout(qrTimeout); // Clear timeout
            
            if (error) {
                console.error('‚ùå QR Code generation error:', error);
                showError('Kh√¥ng th·ªÉ t·∫°o m√£ QR. S·ª≠ d·ª•ng thanh to√°n tr·ª±c ti·∫øp.');
                // Show manual payment as fallback
                document.getElementById('manual-payment-section').style.display = 'block';
                document.getElementById('vnpay-manual-link').href = vnpayUrl;
            } else {
                console.log('‚úÖ QR Code generated successfully');
                // Show QR code and hide loading
                document.getElementById('qr-loading').style.display = 'none';
                document.getElementById('qr-code-container').style.display = 'block';
                document.getElementById('payment-instructions').style.display = 'block';
                document.getElementById('manual-payment-section').style.display = 'block';

                // Set manual payment link
                document.getElementById('vnpay-manual-link').href = vnpayUrl;

                // Update status
                updatePaymentStatus('info', 'Qu√©t m√£ QR ho·∫∑c nh·∫•n "Thanh to√°n tr·ª±c ti·∫øp" ƒë·ªÉ ti·∫øp t·ª•c');
                
                // Update main status
                document.getElementById('payment-status').innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> ƒêang ch·ªù thanh to√°n...
                    </div>
                `;
            }
        });
    }

    // Refresh QR Code
    function refreshQRCode() {
        document.getElementById('qr-code-container').style.display = 'none';
        document.getElementById('qr-loading').style.display = 'block';
        setTimeout(generateQRCode, 1000);
    }

    // Start payment polling with optimized intervals
    function startPaymentPolling() {
        console.log('üîÑ Starting payment polling...');
        let pollCount = 0;
        
        paymentCheckInterval = setInterval(() => {
            pollCount++;
            checkPaymentStatus(pollCount);
        }, 5000); // Check every 5 seconds (reduced from 3)
    }

    // Check payment status via AJAX with timeout
    function checkPaymentStatus(pollCount) {
        console.log(`üîç Checking payment status (attempt ${pollCount})...`);
        
        // Create timeout for fetch request
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 8000); // 8 second timeout
        
        fetch(`/payment/vnpay/check-status/${orderId}`, {
            signal: controller.signal
        })
            .then(response => {
                clearTimeout(timeoutId);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('üìä Payment status response:', data);
                if (data.success) {
                    if (data.status === 'Paid') {
                        console.log('‚úÖ Payment successful!');
                        clearInterval(paymentCheckInterval);
                        clearInterval(countdownInterval);
                        showPaymentSuccess(data);
                    } else if (data.status === 'Failed') {
                        console.log('‚ùå Payment failed!');
                        clearInterval(paymentCheckInterval);
                        clearInterval(countdownInterval);
                        showPaymentFailed();
                    }
                    // Continue polling for PENDING status
                } else {
                    console.log('‚ö†Ô∏è Unsuccessful response:', data);
                }
            })
            .catch(error => {
                clearTimeout(timeoutId);
                console.error('‚ùå Error checking payment status:', error);
                
                // If too many consecutive errors, show fallback message
                if (pollCount > 10) {
                    updatePaymentStatus('warning', 'M·∫•t k·∫øt n·ªëi. Vui l√≤ng ki·ªÉm tra l·∫°i sau ho·∫∑c li√™n h·ªá h·ªó tr·ª£.');
                }
            });
    }

    // Start countdown timer
    function startCountdown() {
        countdownInterval = setInterval(() => {
            timeLeft--;

            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            document.getElementById('countdown-timer').textContent = timeString;

            if (timeLeft <= 0) {
                clearInterval(countdownInterval);
                clearInterval(paymentCheckInterval);
                showPaymentTimeout();
            }
        }, 1000);
    }

    // Update payment status message
    function updatePaymentStatus(type, message) {
        const statusElement = document.getElementById('status-updates');
        const alertClass = type === 'success' ? 'alert-success' :
            type === 'error' ? 'alert-danger' : 'alert-info';

        statusElement.innerHTML = `
                <div class="alert ${alertClass}">
                    <i class="fas fa-info-circle"></i>
                    <span id="status-message">${message}</span>
                </div>
            `;
    }

    // Show payment success
    function showPaymentSuccess(data) {
        updatePaymentStatus('success', 'Thanh to√°n th√†nh c√¥ng! ƒêang chuy·ªÉn h∆∞·ªõng...');
        setTimeout(() => {
            window.location.href = `/payment/vnpay-payment-return?vnp_TransactionStatus=00&vnp_OrderInfo=${orderId}&vnp_TransactionNo=${data.transactionId || 'N/A'}&vnp_PayDate=${new Date().toISOString().replace(/[^\d]/g, '').slice(0, 14)}&vnp_Amount=${/*[[${totalAmount}]]*/ '0'}00`;
        }, 2000);
    }

    // Show payment failed
    function showPaymentFailed() {
        updatePaymentStatus('error', 'Thanh to√°n th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i.');
        setTimeout(() => {
            window.location.href = '/payment/vnpay-payment-return?vnp_TransactionStatus=01';
        }, 3000);
    }

    // Show payment timeout
    function showPaymentTimeout() {
        updatePaymentStatus('error', 'H·∫øt th·ªùi gian thanh to√°n. Vui l√≤ng th·ª≠ l·∫°i.');
        setTimeout(() => {
            window.location.href = '/cart/checkout';
        }, 3000);
    }

    // Show error
    function showError(message) {
        updatePaymentStatus('error', message);
        document.getElementById('qr-loading').style.display = 'none';
    }

    // Clean up intervals when page unloads
    window.addEventListener('beforeunload', function() {
        if (paymentCheckInterval) clearInterval(paymentCheckInterval);
        if (countdownInterval) clearInterval(countdownInterval);
    });
</script>
</body>
</html> 